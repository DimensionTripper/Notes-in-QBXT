---
title: 济南清北学堂 Day1
---

# Day1 高级数据结构

## 树状数组

略

### 例题

#### T1 矩形数点

##### 题意

给出 $n$ 个点，每次查询在一个指定矩形内部的点的数量

##### 思路

二维偏序+容斥瞎搞一搞就完了（

#### T2 逆序对

##### 题意

给出一个数列，可以修改任何一个数的正负号，问逆序对的数量最小值

##### 思路

考虑对于每一个 $A_i$ 其前后绝对值大于等于 $|A_i|$ 的数字是没有用处的，因为无论如何改变符号也不会对逆序对数量产生影响。

于是我们只考虑绝对值小于 $|A_i|$ 的数，设 $A_i$ 前有 $a$ 个， $A_i$ 后有 $b$ 个，若 $A_i > 0$ 则逆序对增加 $b$ 个，否则增加 $a$ 个

于是把 $A$ 离散后用树状数组求一下 $a, b$ 就行了。

---

## 线段树

略

### 李超线段树

船新的科技。

例：有一个二维平面，兹磁往里面插入线段，每次查询与所有线段与直线 $x = x_0$ 的焦点的纵坐标的最大/最小值

以最大值为例，对于一个区间，我们把覆盖该区间的折线的所有组成部分中在 $x$ 轴上投影最长的那条线段所属的线段称为该区间的优势线段。

我们考虑用线段树维护区间的优势线段，考虑每次插入的线段与区间上原本优势线段的关系，大抵有以下四种：

* 区间尚无优势线段：直接修改
* 新插入线段覆盖原线段：直接修改
* 原线段覆盖新插入线段：直接返回
* 新插入线段与原线段有交点：比较哪一条更优势，将不优势的一条下放到交点所在区间

询问就从下往上把所有经过的区间答案取最大值就行了。

### 例题

#### T1 序列操作

##### 题意

给出一个序列，兹磁区间加、区间赋值、查询区间极值、区间和

##### 思路

板子题，注意一下 $lazy\ tag$ 下放时的问题就行了

#### T2 环上最大连续和

##### 题意

给出一个环状序列，兹磁单点修改和查询最大连续和

##### 思路

考虑环是首尾相接的，所以除了朴素的最大子段和求法外还有一个前缀和一个后缀的组合，所以用线段树维护区间内最大前缀和、最大后缀和、最大连续和的同时还要维护最小前缀和、最小后缀和、最小连续和。

最后的答案就是 max(非环时的最大子段和，序列中所有数的和-最小连续和)

#### T3 游戏（SDOI 2016）

##### 题意

给出一棵树，每次操作为把一条链上的点权与一个等差数列的对应项取最小值，查询链上点权最小值。

##### 思路

考虑先树剖转成序列，然后等差数列相当于插入一条方程为 $y = kx + b$ 的线段，然后就是超哥线段树板子了

### EX-线段树合并

由于线段树结构很整齐，所以可以兹磁 $O(logn)$ 的合并

```cpp
il int Merge(int x, int y, int l, int r)
{
	if (!x || !y)
		return x + y;
	if (l == r)
		return Merge_Leaf(x, y);
	int mid = (l + r) >> 1;
	ls[x] = Merge(ls[x], ls[y], l, mid);
	rs[x] = Merge(rs[x], rs[y], mid + 1, r);

	Pushup(x);
}
```

---

## 可并堆（左偏树）

左偏树是支持 $O(logn)$ 合并的堆

左偏树呈二叉树结构，除维护权值信息外，还需维护子树内最近叶节点的距离 $d_i$ 。

以小根堆为例，要求根的权值 $\leq$ 左右儿子权值，且 $d_{lson} \geq d_{rson}$ 

```cpp
il int Merge(int x, int y)
{
	if (!x || !y)
		return x + y;
	if (v[x] > v[y])
		swap(x, y);
	rs[x] = Merge(rs[x], y);
	if (d[ls[x]] < d[rs[x]])
		swap(ls[x], rs[x]);
	d[x] = d[rs[x]] + 1;
	return x;
}
```

### 例题

#### T1 Dispatching（APIO 2012）

##### 题意

给出一棵有根树，每个点有一个价值和一个花费，要求选出一棵子树，在其中选出若干个花费和不超过 $m$ 的点，使得选出点的数量与选出子树的根节点的价值之积最大。

##### 思路

暴力枚举选的子树的根节点，然后用左偏树维护子树内的点，每次先合并子树与选出节点，然后一个个删除花费最大的点，直至花费和不大于 $m$ 。

---

## 平衡树

略

### 启发式合并

就是有序的暴力合并（

### 例题

#### T1 序列终结者

##### 题意

给出一个序列，兹磁区间加、区间翻转、查询区间最大值

##### 思路

SB题，Splay维护下标就完了。

---

## 嵌套数据结构

一般指树套树，是个毒瘤玩意（

其思想是将普通的数据结构维护的信息拓展成另一种数据结构（可能与第一维数据结构相同）

出于时间、空间等方面的考虑，第一维一般都是树状数组这种比较简单的东西

### 例题

#### T1 Mokia（BZOJ 1176）

##### 题意

给出一个 $w \times w$ 的矩阵，初始值均为 $s$ ，每次操作可以增加某个格子的权值，或询问一个矩形内所有格子的权值和。

##### 思路

考虑用树状数组套平衡树，把树状数组中的 $c$ 数组替换成平衡树维护的包含区间内纵坐标的集合。

---

## 主席树

可持久化数据结构就是利用函数式编程的思想使其支持询问历史版本，同时充分利用它们之间的共同数据来减少时间和空间消耗。
大致的思想就是只新建不修改,保存历史版本——即每次加入新结点后都返回一颗包含新结点的新树保存起来，同时充分利用历史版本中相同的节点以节省空间。

### 例题

#### T1 静态区间第k小

略

#### T2 数颜色

##### 题意

给出一个序列，每次查询某个区间中不同的数的个数，强制在线。

##### 思路

用 $last_i$ 表示 $a_i$ 上一次出现的位置然后维护区间内满足 $last_i < l$ 的 $i$ 有几个

---

## 动态树（LCT）

动态树问题要求我们维护一个由若干棵子结点无序的有根树组成的森林,支持对树的分裂、合并、换根,以及对某个点到它的根的路径的某些操作，一般通过 Splay 维护的 LCT 实现。

### 例题

#### T1 动态图连通性

##### 题意

给出一张无向图，兹磁添加/删除无向边，每次查询两点的连通性

##### 思路

预处理每一条边被删除的时刻得到 $t$ 数组，然后用 LCT 维护对于 $t$ 的最大生成树即可，加入边 $(u, v, t_i)$ 的时候先判断 $u, v$ 是否连通，若不连通直接加入，否则比较一下 $t_i$ 与 $u, v$ 路径上的最小的 $t_j$ 的大小，若 $t_i > t_j$ 则用新边替换旧边。删除则看 $(u, v)$ 是否在最大生成树中，若在则将其删除。查询时直接在最大生成树上查 $u, v$ 的连通性即可。

---

## 综合例题

### T1 三位偏序

#### 题意

给出三个长度为 $n(n\leq5e6)$ 的排列 $A,B,C$ ，统计有多少对 $(i, j)$ 满足 $A_i < A_j, B_i < B_j, C_i < C_j$ 

#### 思路

这道题并不是朴素的三位偏序，所以CDQ这种东西做不了。

考虑由题目中给出的条件， $A,B,C$ 为3个排列，所以我们假设 $X$ 为 $A,B$ 中满足条件的数量， $Y$ 为 $B, C$ 中的数量， $Z$ 为 $A,C$ 中的数量。然后可以发现，若一对 $(i, j)$ 同时满足两个则一定满足三个，如果设答案为 $Ans$ ，不合法对数为 $illegal$ ，那么我们有以下两个式子：
$$
Ans = C_n^2 - illegal\\
X + Y + Z = 3 \times Ans + illegal
$$
变形得
$$
Ans = \dfrac{1}{2} \times (X + Y + Z - C_n^2)
$$
然后就是二维偏序问题了。

### T2 动态区间第k小

#### 题意

兹磁单点修改的区间第k小

#### 思路

树状数组套主席树，询问第 k 小数时根据树状数组拆分成 $logn$ 棵主席树，在上面同时进行二分即可

### T3 GERALD07加强版（BZOJ 3514）

#### 题意

给出一个无向图，每次询问保留编号在 $[l,r]$ 的边形成的图中连通块的个数，强制在线。

#### 思路

首先把边依次加到图中，用 LCT 维护加入时间的最大生成树。若当前这条边与图中的边形成了环，那么把这个环中最早加进来的边弹出去，并记录每条边把哪条边弹了出去，设为 $p_i$ 。特别地，要是没有弹出边， $p_i = 0$ 。

对于每个询问，答案即为 $n - \sum\limits_{i = l}^r[p_i < l]$ ，这可以使用主席树在 $O(logn)$ 的时间内求出。

正确性:如果一条边 $p_i \geq l$ ，那么它可显然以与 $[l, r]$ 中的边形成环，对答案没有贡献。反之它与 $[l, r]$ 中的边是不能形成环的，那么它对答案的贡献为−1。

